exports = async function (assembly, motorId) {
  const serviceName = "mongodb-atlas";
  const dbName = "HrDataDev";

  const db = context.services.get(serviceName).db(dbName);
  const collection = db.collection("calibMotorsConfiguration");

  let configuration;

  // Find configuration
  try {
    configuration = await collection.findOne({ assembly });
  } catch (err) {
    console.log("Error occurred while getting configuration:", err.message);
    return { error: err.message };
  }

  let motors = configuration.motors || [];

  // Update motors list
  const index = motors.findIndex((m) => m.descId === motorId);
  if (index === -1) {
    return { error: "Motor does not exist" };
  } else {
    motors.splice(index, 1);
  }

  // Save updated configuration
  try {
    await collection.updateOne({ assembly }, { ...configuration, motors });
  } catch (err) {
    console.log("Error occurred while updating motor:", err.message);
    return { error: err.message };
  }

  // Get updated configuration
  try {
    configuration = await collection.findOne({ assembly });
  } catch (err) {
    console.log("Error occurred while getting motor:", err.message);
    return { error: err.message };
  }

  return { result: configuration };
};
